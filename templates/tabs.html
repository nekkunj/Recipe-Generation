{% extends 'index.html' %}

{% block head %}
<title>Food.com</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    .div-body {
        padding: 20px;
    }
    .card {
      width: 18rem;
    }
    .card img {
      height: 50%;
      object-fit: cover;
    }
    .card-body {
      height: 50%;
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        color: black; /* Change the color to black */
    }
  </style>
{% endblock %}
 
{% block body %}
<div class="div-body">
    <h2 style="text-align: center;">Food.com</h2>
    
    <!-- Bootstrap Nav Tabs -->
    <ul class="nav nav-tabs" id="recipeTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="recipeGen-tab" data-toggle="tab" href="#recipeGen" role="tab" aria-controls="recipeGen" aria-selected="true">Recipe Generation</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="ingSugg-tab" data-toggle="tab" href="#ingSugg" role="tab" aria-controls="ingSugg" aria-selected="false">Ingredients Suggestion</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="ingRep-tab" data-toggle="tab" href="#ingRep" role="tab" aria-controls="ingRep" aria-selected="false">Ingredients Replacement</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="mealPlan-tab" data-toggle="tab" href="#mealPlan" role="tab" aria-controls="mealPlan" aria-selected="false">Meal Planner</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="recipeTabsContent">
        <div class="tab-pane fade show active" id="recipeGen" role="tabpanel" aria-labelledby="recipeGen-tab">
                <div class="container-fluid">
                    <h3>Recipe Generation</h3>
                    <form id="recipeForm">
                        <div class="form-group">
                            <label for="recipeQuality">What kind of recipe do you want to cook today?</label>
                            <input type="text" class="form-control" id="recipeQuality" name="recipe_quality" placeholder="Enter something" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="generateRecipeBtn">Generate Recipe</button>
                    </form>
                    <div id="carouselExampleControls" class="carousel slide" data-ride="carousel" data-interval="10000">
                      <div class="carousel slide" data-ride="carousel" id="recipeResponse">
                        <div class="carousel-inner" >

                            <!-- Cards will be appended here -->
                        </div>
                      </div>
                      <a class="carousel-control-prev" href="#carouselExampleControls" role="button"  data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                      </a>
                      <a class="carousel-control-next" href="#carouselExampleControls" role="button"  data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                      </a>
                    </div>
            </div> <!-- This div will display the response -->
        </div>  
        <div class="tab-pane fade" id="ingSugg" role="tabpanel" aria-labelledby="ingSugg-tab">
            <h3>Ingredients Suggestion</h3>
            <form id="ingredientSuggestionForm">
                <div class="form-group">
                    <label for="ingredientName">Enter ingredients?</label>
                    <input type="text" class="form-control" id="ingredientName" name="ingredient_Name" placeholder="Enter Ingredients and separate them by comma">
                </div>
                <button type="submit" class="btn btn-primary">Suggest</button>
            </form>
        </form>
        <div id="suggestionResponse"></div> 
        </div>
        <div class="tab-pane fade" id="ingRep" role="tabpanel" aria-labelledby="ingRep-tab">
            <h3>Ingredients Replacement</h3>
            <form id="ingredientReplacementForm">
                <div class="form-group">
                    <label for="ingredientName">What ingredient you don't have?</label>
                    <input type="text" class="form-control" id="ingredientName" name="ingredient_Name" placeholder="Enter Ingredients and separate them by comma">
                </div>
                <button type="submit" class="btn btn-primary">Suggest</button>
            </form>
        </form>
        <div id="receipeReplacement_Response"></div>
        </div>
        <div class="tab-pane fade" id="mealPlan" role="tabpanel" aria-labelledby="mealPlan-tab">
            <h3>Meal Planner</h3>
            <!-- Add content for Meal Planner tab here -->
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function(){
        $('#recipeTabs a').click(function(e){
            e.preventDefault();
            $(this).tab('show');
        });
    });
</script>
<script>
    $(document).ready(function(){

        function extractFirstUrl(input) {
            const regex = /https?:\/\/[^ ]+\.jpg/g;
            const match = input.match(regex);
            if (match && match.length > 0) {
                return match[0];
            } else {
                return "No URL found";
            }
        }
        function formatIngredients(str,quantities) {
            const substring = str.substring(3, str.length - 2);
            var quantity_substring = quantities.substring(3, str.length - 2);
            quantity_substring=quantity_substring.replace(/NA/g, '"few"');
            const ingredients = substring.split('", "').map(value => value.trim());
            const quantityValues = quantity_substring.split('", "').map(value => value.trim());
            // console.log(quantityValues)
            // console.log(ingredients)
            let formattedIngredients = '';
            // Iterate over both arrays simultaneously
            for (let i = 0; i < ingredients.length; i++) {
                const ingredient = ingredients[i];
                let quantity = quantityValues[i];
                // console.log(quantity,ingredient )
                // If quantity is "NA", replace it with "few"
                if (quantity === "NA") {
                    quantity = "few";
                }

                // Construct the formatted string
                formattedIngredients += `${quantity} ${ingredient}`;

                // Add a comma if it's not the last ingredient
                if (i < ingredients.length - 1) {
                    formattedIngredients += ', ';
                }
            }

            return formattedIngredients;
        }
        function formatRecipeInstructions(instructions) {
            // Remove leading and trailing "c(" and ")" and escape characters
            instructions = instructions.replace(/^c\(\"|\"\)$/g, '').replace(/\\"/g, '"');

            // Split the instructions into individual steps
            const steps = instructions.split('", "');

            // Initialize an empty string to store the formatted instructions
            let formattedInstructions = `<br />`;

            // Iterate over each step
            steps.forEach((step, index) => {
                // Add a pointer (numbered list) and the step to the formatted instructions
                formattedInstructions += `${index + 1}. ${step}<br />`;
            });

            // Return the formatted instructions
            return formattedInstructions;
        }
        $('#recipeForm').submit(function(e){
            e.preventDefault();
            console.log(formatIngredients("\"tofu\"","c(\"1\", NA, NA, NA, NA, \"2\", \"1 1/2\")"))
            $('#recipeResponse .carousel-inner').empty();
            $('#generateRecipeBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating Recipe...');
            $.ajax({
                type: 'POST',
                url: '/generate_recipe',
                data: $(this).serialize(),
                complete: function(xhr, status){
                    if (status === "success" || xhr.status === 200) {
                        // var response = JSON.parse(resp.recipe);
                        var responseText = xhr.responseText;
                        var response;
                        try {
                            response = JSON.parse(responseText);
                        } catch (error) {
                            console.error("Error parsing JSON response:", error);
                            return; // Exit function if unable to parse JSON
                        }
                        console.log(response.recipe)
                        response.recipe.forEach(function(obj,index) {
                            // Create card HTML
                            var card = `
                                <div class="carousel-item" style="background-color:white">
                                <div class="card w-100">
                                    <h5 style= "text-align:center" class="card-title"> ${obj.Name} (Similarity Score: ${obj.Score})</h5>
                                    <img src="${extractFirstUrl(obj.Images)}" class="card-img-top" alt="Recipe Image" style="height: 500px;">
                                    <div class="card-body">
                                    <p class="card-text"><b>Description: </b>${obj.Description}</p>
                                    <p class="card-text"><b>Ingredients: </b>${formatIngredients(obj.RecipeIngredientParts,obj.RecipeIngredientQuantities)}</p>
                                    <p class="card-text"><b>Instructions: </b>${formatRecipeInstructions(obj.RecipeInstructions)}</p>
                                    
                                    </div>
                                </div>
                                </div>  
                            `;
                            // Append card to carousel inner
                            $('#recipeResponse .carousel-inner').append(card);
                            
                        });
                        // Set the first card as active
                        $('#recipeResponse .carousel-item:first-child').addClass('active');
                        $('#generateRecipeBtn').prop('disabled', false).html('Generate Recipe');
                    }
                    else{
                        $('#generateRecipeBtn').prop('disabled', false).html('Generate Recipe');
                    }
            },
                
            });
        });



        $('#ingredientSuggestionForm').submit(function(e){
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '/suggest_ingredient',
                data: $(this).serialize(),
                success: function(response){
                    $('#suggestionResponse').html(response.recipe);
                }
            });
        });
        $('#ingredientReplacementForm').submit(function(e){
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '/receipe_replacement',
                data: $(this).serialize(),
                success: function(response){
                    $('#receipeReplacement_Response').html(response.recipe);
                }
            });
        });

    
    });
</script>
{% endblock %}
